name: CI

on:
  push:
    branches: [main]
  pull_request:
  workflow_dispatch:

# ── No secrets required for any job below ─────────────────────────────────────
# All jobs run against the local codebase only.
# Live integration (requires BUNNYDB_* secrets) is a separate optional workflow.

jobs:
  # ── 1. Format check ──────────────────────────────────────────────────────────
  fmt:
    name: Rustfmt
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt

      - name: Check formatting
        run: cargo fmt --all --check

  # ── 2. Clippy (native) ───────────────────────────────────────────────────────
  clippy:
    name: Clippy
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy

      - name: Run clippy
        # --lib --tests to avoid pulling in dev-example deps that require a
        # live BunnyDB connection or GUI libraries unavailable on CI runners.
        run: cargo clippy --lib --tests --all-features -- -D warnings

  # ── 3. Unit tests (no network, no secrets) ───────────────────────────────────
  test:
    name: Unit tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@stable

      - name: Run unit tests
        # --lib runs only in-crate unit tests; no integration tests that need
        # a live BunnyDB pipeline URL or token.
        run: cargo test --lib --all-features

  # ── 4. WASM compile check ────────────────────────────────────────────────────
  wasm:
    name: WASM check (wasm32-unknown-unknown)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: wasm32-unknown-unknown

      - name: cargo check --target wasm32-unknown-unknown
        run: cargo check --target wasm32-unknown-unknown

  # ── 5. MSRV check ────────────────────────────────────────────────────────────
  msrv:
    name: MSRV (Rust 1.75)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@master
        with:
          toolchain: "1.75"

      - name: cargo check on MSRV
        run: cargo check --lib --all-features
